@page "/recuperarsenha"
@inject RecoveryCodeService CodeService
@inject EmailService EmailService
@inject NavigationManager Navigation

<div class="container">
    <div class="logo">
        <img src="logo.png" alt="Logo do Cantinho da Doçura" />
    </div>

    <h2>Recuperar palavra-passe</h2>
    <p>Indique o seu email</p>
    <form @onsubmit="HandlePasswordRecovery">
        <input type="email" placeholder="EMAIL" @bind="Email" required />
        <button type="submit">Confirmar</button>
    </form>
</div>

@code {
    private string Email { get; set; } = string.Empty;

    private async Task HandlePasswordRecovery()
    {
        try
        {
            string code = GenerateCode();
            string subject = "Recuperação de Senha - Cantinho da Doçura";
            string body = $"Olá,<br><br>Seu código de recuperação de senha é: <strong>{code}</strong><br><br>Equipe Cantinho da Doçura";

            // Enviar o email
            await EmailService.SendEmailAsync(Email, subject, body);

            // Salvar o código no serviço
            CodeService.SaveCode(Email, code);

            Console.WriteLine($"Código enviado para: {Email}");

            // Redirecionar para a página de inserção do código
            Navigation.NavigateTo($"/recuperarsenha/codigo?email={Uri.EscapeDataString(Email)}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao enviar email: {ex.Message}");
        }
    }

    private string GenerateCode()
    {
        // Gera um código simples de 6 dígitos
        return new Random().Next(100000, 999999).ToString();
    }
}
